# Ordination Plots

Ordination reduces a complex community table into a small number of axes that summarize between-sample dissimilarity.

The goal is not to compress biology into two numbers.
The goal is to visualize structure, then interpret it cautiously.

:::cdi-message
Ordination shows patterns of similarity between samples.

It does not explain why samples differ.
Interpretation requires context, careful preprocessing, and validation.
:::

This chapter focuses on:

- Bray–Curtis distance and why it is common
- PCoA ordination and what the axes mean
- how to read clustering and overlap
- how to avoid common interpretation traps

---

## Load data

```{r load-phyloseq}
ps <- readRDS("data/moving-pictures-ps.rds")
```

---

## Transform to relative abundance

Bray–Curtis is commonly applied to relative abundance in exploratory ordination.
This does not remove compositional constraints, but it enables clearer comparison across samples.

```{r transform-relative}
ps_rel <- phyloseq::transform_sample_counts(ps, function(x) x / sum(x))
```

:::cdi-message
Relative abundance ordination is descriptive.

If you change filtering or aggregation choices, the geometry can change.
This is expected and should be reported.
:::

---

## Compute Bray–Curtis distance

```{r bray-curtis-distance}
dist_bc <- phyloseq::distance(ps_rel, method = "bray")

# Compact distance overview (avoid printing the full dist object)
n_samples <- phyloseq::nsamples(ps_rel)
n_pairs <- length(dist_bc)

dist_summary <- stats::quantile(
  as.numeric(dist_bc),
  probs = c(0, 0.25, 0.5, 0.75, 1),
  names = TRUE
)

data.frame(
  n_samples = n_samples,
  n_pairs = n_pairs,
  t(round(dist_summary, 4)),
  row.names = NULL,
  check.names = FALSE
)

# Small preview (first 6 samples)
as.matrix(dist_bc)[1:6, 1:6]
```

---

## PCoA ordination

We compute a PCoA (principal coordinates analysis) on the Bray–Curtis distance matrix.

```{r pcoa-ordination}
ord <- phyloseq::ordinate(ps_rel, method = "PCoA", distance = dist_bc)

# Coordinates for the first two axes
coords <- as.data.frame(ord$vectors[, 1:2])
colnames(coords) <- c("PC1", "PC2")

# Percent variance explained (if available)
eig <- ord$values$Relative_eig
var_pc1 <- if (!is.null(eig) && length(eig) >= 1) eig[1] * 100 else NA_real_
var_pc2 <- if (!is.null(eig) && length(eig) >= 2) eig[2] * 100 else NA_real_

meta <- data.frame(phyloseq::sample_data(ps_rel))
meta$sample_id <- rownames(meta)

coords$sample_id <- rownames(coords)
ord_df <- merge(coords, meta, by = "sample_id", all.x = TRUE)

# Robust body site column detection
cols <- names(ord_df)
body_col <- intersect(c("body-site", "body.site", "body_site"), cols)

if (length(body_col) == 0) {
  stop("Body site column not found in metadata. Available columns: ", paste(cols, collapse = ", "))
}

ord_df$body_site <- ord_df[[body_col[1]]]

# Axis labels with variance (if available)
pc1_label <- if (is.na(var_pc1)) "PC1" else sprintf("PC1 (%.1f%%)", var_pc1)
pc2_label <- if (is.na(var_pc2)) "PC2" else sprintf("PC2 (%.1f%%)", var_pc2)

# Export tables for reproducibility
dir.create("outputs/tables", recursive = TRUE, showWarnings = FALSE)

readr::write_csv(
  ord_df[, c("sample_id", "PC1", "PC2", "body_site")],
  "outputs/tables/ordination-pcoa.csv"
)

readr::write_csv(
  data.frame(PC1 = var_pc1, PC2 = var_pc2),
  "outputs/tables/ordination-variance.csv"
)

head(ord_df[, c("sample_id", "PC1", "PC2", "body_site")])
```

:::cdi-message
PCoA axes are not biological variables.

They are directions that best summarize pairwise dissimilarities.
Axis labels are useful, but do not overinterpret them.
:::

---

## Ordination plot

This plot shows samples in PCoA space, colored by body site.

- Points close together have more similar community composition (under Bray–Curtis).
- Separation can reflect biology, but it can also reflect preprocessing choices or technical structure.

```{r plot-ordination, fig.width=10, fig.height=6}
plot_df <- ord_df
plot_df$body_site <- as.factor(plot_df$body_site)

# Centroids for each group (for visual guidance only)
centroids <- dplyr::summarise(
  dplyr::group_by(plot_df, body_site),
  PC1 = mean(PC1, na.rm = TRUE),
  PC2 = mean(PC2, na.rm = TRUE),
  n = dplyr::n(),
  .groups = "drop"
)

ggplot2::ggplot(plot_df, ggplot2::aes(x = PC1, y = PC2, color = body_site)) +
  ggplot2::geom_point(size = 3, alpha = 0.85) +
  ggplot2::stat_ellipse(
    ggplot2::aes(group = body_site),
    type = "norm",
    level = 0.95,
    linewidth = 0.9,
    alpha = 0.15,
    show.legend = FALSE
  ) +
  ggplot2::geom_point(
    data = centroids,
    ggplot2::aes(x = PC1, y = PC2),
    shape = 4,
    stroke = 1.2,
    size = 5,
    show.legend = FALSE
  ) +
  ggplot2::labs(
    title = "PCoA ordination (Bray–Curtis)",
    subtitle = "Samples colored by body site. X marks show group centroids (descriptive).",
    x = pc1_label,
    y = pc2_label,
    color = "Body site"
  ) +
  ggplot2::theme_bw(base_size = 13) +
  ggplot2::theme(
    plot.title = ggplot2::element_text(hjust = 0.5, face = "bold"),
    plot.subtitle = ggplot2::element_text(hjust = 0.5),
    panel.grid.minor = ggplot2::element_blank(),
    legend.position = "right"
  )
```

:::cdi-message
How to read this plot:

- Clear separation suggests that body site is a major driver of between-sample differences.
- Overlap suggests either shared composition, within-group heterogeneity, or insufficient resolution at this preprocessing level.

Do not treat visual separation as proof.

In the premium continuation, we test whether metadata variables explain a significant fraction of variance using methods like PERMANOVA.
:::
